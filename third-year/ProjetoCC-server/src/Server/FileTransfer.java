/*  * Copyright (C) 2015 José Sousa & Nuno Carvalho * * This program is free software: you can redistribute it and/or modify * it under the terms of the GNU General Public License as published by * the Free Software Foundation, either version 3 of the License, or * (at your option) any later version. * * This program is distributed in the hope that it will be useful, * but WITHOUT ANY WARRANTY; without even the implied warranty of * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the * GNU General Public License for more details. * * You should have received a copy of the GNU General Public License * along with this program.  If not, see <http://www.gnu.org/licenses/>. *//*  * Copyright (C) 2015 José Sousa & Nuno Carvalho * * This program is free software: you can redistribute it and/or modify * it under the terms of the GNU General Public License as published by * the Free Software Foundation, either version 3 of the License, or * (at your option) any later version. * * This program is distributed in the hope that it will be useful, * but WITHOUT ANY WARRANTY; without even the implied warranty of * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the * GNU General Public License for more details. * * You should have received a copy of the GNU General Public License * along with this program.  If not, see <http://www.gnu.org/licenses/>. *//*  * Copyright (C) 2015 josesousa9000@gmail.com * * This program is free software: you can redistribute it and/or modify * it under the terms of the GNU General Public License as published by * the Free Software Foundation, either version 3 of the License, or * (at your option) any later version. * * This program is distributed in the hope that it will be useful, * but WITHOUT ANY WARRANTY; without even the implied warranty of * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the * GNU General Public License for more details. * * You should have received a copy of the GNU General Public License * along with this program.  If not, see <http://www.gnu.org/licenses/>. *//*  * Copyright (C) 2015 José Francisco & Nuno Carvalho * * This program is free software: you can redistribute it and/or modify * it under the terms of the GNU General Public License as published by * the Free Software Foundation, either version 3 of the License, or * (at your option) any later version. * * This program is distributed in the hope that it will be useful, * but WITHOUT ANY WARRANTY; without even the implied warranty of * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the * GNU General Public License for more details. * * You should have received a copy of the GNU General Public License * along with this program.  If not, see <http://www.gnu.org/licenses/>. */package Server;import Net.CCPacket;import Net.CCSocket;import Net.ExcessBytesException;import Net.PacketTooSmallException;import java.io.FileOutputStream;import java.io.IOException;import java.math.BigInteger;import java.net.SocketAddress;import java.net.SocketException;import java.net.SocketTimeoutException;import java.nio.file.Files;import java.nio.file.Paths;import java.util.Random;import org.apache.commons.lang3.ArrayUtils;/** * * @author José Francisco & Nuno Carvalho */public class FileTransfer {    public static void sendFile(CCSocket socket, SocketAddress addr, int label, byte file[]) throws IOException, ExcessBytesException, PacketTooSmallException{        Random labelGen = new Random();        boolean good;        byte[] OK = {0};        int j = 0, tries;        //armazenar todos os bytes do ficheiro        for (int i = 0; i < file.length; i += 45000, j++) {            good = false;            CCPacket ccp = new CCPacket((byte) 0, (byte) 0, label, (byte) 0);            ccp.addCampo((byte) 17, BigInteger.valueOf((short) j).toByteArray());            ccp.addCampo((byte) 18, ArrayUtils.subarray(file, i, i + 45000));            //se nao for o ultimo packet            if (i + 45000 < file.length) {                ccp.addCampo((byte) 254, OK);            }            //enquanto n receber reply reenviar pacote            tries = 0;            while (!good) {                try {                    //tentativas de reenvio limite                    if (tries == 10) {                        throw new SocketException("10 Tentativas de reenvio sem respsota!"                                + "Cliente unreachable!");                    }                    socket.send(ccp, addr);                    socket.setTimeout(300);                    CCPacket rep = socket.receive();                    //caso se receba um pacote de outra comunicação, processar                    if (rep.getLabel() != label) {                        GameServer.sendError(socket, "Server ocupado. Aguarde uns instantes e tente"                                + "mais tarde!", (short) labelGen.nextInt(Short.MAX_VALUE), rep.getSender());                    } else {                        socket.setTimeout(0);                        good = true;                    }                } catch (SocketTimeoutException e) {                    tries++;                }            }        }    }}